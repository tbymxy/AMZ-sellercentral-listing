// ==UserScript==
// @name             äºšé©¬é€ŠListingå…¨èƒ½è¾…åŠ©å·¥å…·ï¼ˆç²¾ç®€ç‰ˆÂ·è‡ªåŠ¨åˆè§„ï¼‰
// @namespace        http://tampermonkey.net/
// @version          8.0
// @description      é›†æˆçˆ¶SKUè‡ªåŠ¨ç”Ÿæˆã€å­SKUå­—æ¯åºåˆ—å¡«å……ã€äº§å“ä¿¡æ¯ä¸€é”®å¡«å†™ã€‚é¡µé¢åŠ è½½åè‡ªåŠ¨å‹¾é€‰â€œæ— å“ç‰Œâ€å’Œâ€œæ— å•†å“ç¼–ç â€ï¼Œä¸€é”®æ¸…ç©ºä»…æ¸…é™¤å†…å®¹ã€‚
// @author           Optimized Version
// @match            https://sellercentral.amazon.com/abis/listing/*
// @match            https://sellercentral.amazon.ca/abis/listing/*
// @match            https://sellercentral.amazon.com.mx/abis/listing/*
// @match            https://sellercentral-japan.amazon.com/abis/listing/*
// @match            https://sellercentral.amazon.com.au/abis/listing/*
// @match            https://sellercentral.amazon.co.uk/abis/listing/*
// @match            https://sellercentral.amazon.de/abis/listing/*
// @match            https://sellercentral.amazon.fr/abis/listing/*
// @match            https://sellercentral.amazon.it/abis/listing/*
// @match            https://sellercentral.amazon.es/abis/listing/*
// @match            https://sellercentral.amazon.nl/abis/listing/*
// @match            https://sellercentral.amazon.se/abis/listing/*
// @match            https://sellercentral.amazon.pl/abis/listing/*
// @match            https://sellercentral.amazon.be/abis/listing/*
// @icon             https://www.amazon.com/favicon.ico
// @grant            GM_setValue
// @grant            GM_getValue
// @grant            GM_addStyle
// ==/UserScript==

(function () {
    'use strict';

    // =============== æ ·å¼æ³¨å…¥ ===============
    const style = document.createElement('style');
    style.textContent = `
        .amazon-helper-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            background: white !important;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            z-index: 99999 !important;
            font-family: Arial, sans-serif;
            font-size: 14px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .amazon-helper-panel h3 {
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            color: #232f3e;
            font-weight: bold;
        }
        .amazon-helper-panel .form-group {
            margin-bottom: 16px;
        }
        .amazon-helper-panel label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #232f3e;
            font-size: 14px;
        }
        .amazon-helper-panel input, .amazon-helper-panel select, .amazon-helper-panel textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #a6a6a6;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            font-family: inherit;
        }
        .amazon-helper-panel input:focus, .amazon-helper-panel select:focus, .amazon-helper-panel textarea:focus {
            outline: none;
            border-color: #ff9900;
            box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.2);
        }
        .amazon-helper-panel .sku-display {
            flex-grow: 1;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            background: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #d4d4d4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 5px;
        }
        .amazon-helper-panel .input-with-buttons {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .amazon-helper-panel .input-with-buttons button {
            width: auto;
            white-space: nowrap;
            padding: 8px 12px;
            border: 1px solid #a6a6a6;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background-color 0.2s ease;
        }
        .amazon-helper-panel .input-with-buttons button.copy-btn {
            background-color: #e6f4ea;
            border-color: #a3d9b1;
            color: #0f7c3d;
        }
        .amazon-helper-panel .input-with-buttons button:hover {
            background-color: #e0e0e0;
        }
        .amazon-helper-panel .input-with-buttons button.copy-btn:hover {
            background-color: #d8f1e0;
        }
        .amazon-helper-panel .button-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        .amazon-helper-panel button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            flex: 1;
        }
        .amazon-helper-panel button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .amazon-helper-panel .primary-btn {
            background-color: #ff9900;
            color: white;
        }
        .amazon-helper-panel .primary-btn:hover:not(:disabled) {
            background-color: #e88a00;
        }
        .amazon-helper-panel .secondary-btn {
            background-color: #e6e6e6;
            color: #333;
        }
        .amazon-helper-panel .secondary-btn:hover:not(:disabled) {
            background-color: #d6d6d6;
        }
        .amazon-helper-panel .tertiary-btn {
            background-color: #28a745;
            color: white;
        }
        .amazon-helper-panel .tertiary-btn:hover:not(:disabled) {
            background-color: #218838;
        }
        .amazon-helper-panel .danger-btn {
            background-color: #dc3545;
            color: white;
        }
        .amazon-helper-panel .danger-btn:hover:not(:disabled) {
            background-color: #c82333;
        }
        .amazon-helper-panel .status-message {
            margin-top: 12px;
            padding: 10px;
            border-radius: 4px;
            display: none;
            font-size: 13px;
            font-weight: 500;
        }
        .amazon-helper-panel .success {
            background-color: #e6f4ea;
            color: #0f7c3d;
            border: 1px solid #a3d9b1;
        }
        .amazon-helper-panel .error {
            background-color: #fde8e8;
            color: #d72e2e;
            border: 1px solid #f8b6b6;
        }
        .amazon-helper-panel textarea {
            min-height: 80px;
            resize: vertical;
        }
        .amazon-helper-panel hr {
            border: none;
            border-top: 1px dashed #ddd;
            margin: 16px 0;
        }
    `;
    document.head.appendChild(style);

    // =============== å·¥å…·å‡½æ•° ===============
    function waitForElement(selector, timeout = 10000) {
        return new Promise((resolve, reject) => {
            const start = Date.now();
            const check = () => {
                const el = document.querySelector(selector);
                if (el) return resolve(el);
                if (Date.now() - start > timeout) return reject(new Error(`Timeout waiting for ${selector}`));
                setTimeout(check, 200);
            };
            check();
        });
    }

    function setKatInputValue(selector, value) {
        const kat = document.querySelector(selector);
        if (!kat || !kat.shadowRoot) return false;
        const real = kat.shadowRoot.querySelector('input');
        if (!real) return false;
        real.value = value;
        real.dispatchEvent(new Event('input', { bubbles: true, composed: true }));
        real.dispatchEvent(new Event('change', { bubbles: true, composed: true }));
        return true;
    }

    function setKatTextareaValue(selector, value) {
        const kat = document.querySelector(selector);
        if (!kat || !kat.shadowRoot) return false;
        const real = kat.shadowRoot.querySelector('textarea');
        if (!real) return false;
        real.value = value;
        real.dispatchEvent(new Event('input', { bubbles: true, composed: true }));
        real.dispatchEvent(new Event('change', { bubbles: true, composed: true }));
        return true;
    }

    function setKatCheckboxChecked(selector, checked) {
        const kat = document.querySelector(selector);
        if (!kat || !kat.shadowRoot) return false;
        const real = kat.shadowRoot.querySelector('input[type="checkbox"]');
        if (!real) return false;
        if (real.checked !== checked) {
            real.click(); // è§¦å‘äºšé©¬é€Šå†…éƒ¨äº‹ä»¶
        }
        return true;
    }

    function showStatus(message, isSuccess) {
        const status = document.getElementById('sc-statusMessage');
        if (!status) return;
        status.textContent = message;
        status.className = `status-message ${isSuccess ? 'success' : 'error'}`;
        status.style.display = 'block';
        setTimeout(() => { status.style.display = 'none'; }, 3000);
    }

    function generateRandomBaseSKU() {
        const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
        const prefix = "A" + date;
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let random = "";
        for (let i = 0; i < 4; i++) {
            random += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return `${prefix}-${random}`;
    }

    function generateLetterSequence(index) {
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let sequence = "";
        let i = index;
        while (i >= 0) {
            sequence = letters[i % 26] + sequence;
            i = Math.floor(i / 26) - 1;
        }
        return sequence;
    }

    function parseBulletText(text) {
        const matches = [...text.matchAll(/ã€(.*?)ã€‘([\s\S]*?)(?=(?:ã€|$))/g)];
        return matches.slice(0, 5).map(m => `ã€${m[1].trim()}ã€‘${m[2].trim().replace(/\n+/g, ' ')}`);
    }

    function convertToAmazonHTML(text) {
        if (!text) return '';
        const paragraphs = text.trim().split(/\n{2,}/).map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`);
        return paragraphs.join('');
    }

    function setInputValue(input, value) {
        const nativeInputValueSetter = Object.getOwnPropertyDescriptor(
            window.HTMLInputElement.prototype, "value"
        ).set;
        nativeInputValueSetter.call(input, value);
        input.dispatchEvent(new Event("input", { bubbles: true, composed: true }));
        input.dispatchEvent(new Event("change", { bubbles: true, composed: true }));
        input.dispatchEvent(new Event("blur", { bubbles: true }));
        input.setAttribute('data-auto-generated', 'true');
    }

    function getAllSKUInputs() {
        const inputs = [];
        document.querySelectorAll('input[aria-label="SKU"]').forEach(input => inputs.push(input));
        if (inputs.length === 0) {
            document.querySelectorAll("kat-input").forEach(kat => {
                if (kat.shadowRoot) {
                    const innerInput = kat.shadowRoot.querySelector('input[aria-label="SKU"]');
                    if (innerInput) inputs.push(innerInput);
                }
            });
        }
        return inputs;
    }

    function setButtonState(button, enabled, text) {
        button.disabled = !enabled;
        button.textContent = text;
    }

    // =============== ä¸»é¢æ¿æ„å»º ===============
    async function initPanel() {
        if (document.getElementById('amazon-helper-panel')) return;

        const panel = document.createElement('div');
        panel.id = 'amazon-helper-panel';
        panel.className = 'amazon-helper-panel';
        panel.innerHTML = `
            <h3>ğŸ“¦ äºšé©¬é€ŠListingå…¨èƒ½åŠ©æ‰‹</h3>

            <h4>ğŸ”¹ SKU è‡ªåŠ¨ç”Ÿæˆ</h4>
            <div class="form-group">
                <label for="sc-baseSKU">çˆ¶SKU</label>
                <div class="input-with-buttons">
                    <div id="sc-baseSKU-display" class="sku-display"></div>
                    <button id="sc-copyBaseSKU" class="copy-btn" title="å¤åˆ¶çˆ¶SKU">å¤åˆ¶</button>
                    <button id="sc-generateRandomSKU" title="ç”Ÿæˆéšæœºçˆ¶SKU">éšæœºç”Ÿæˆ</button>
                </div>
            </div>
            <div class="button-group">
                <button id="sc-fillSKU" class="primary-btn" disabled>ä¸€é”®ç”Ÿæˆå­SKU</button>
                <button id="sc-clearSKU" class="secondary-btn" disabled>æ¸…ç©ºè‡ªåŠ¨ç”ŸæˆSKU</button>
            </div>
            <hr>

            <h4>ğŸ“ äº§å“ä¿¡æ¯å¡«å†™</h4>
            <div class="form-group">
                <label for="my-title">æ ‡é¢˜</label>
                <input type="text" id="my-title" placeholder="è¾“å…¥äº§å“æ ‡é¢˜" />
            </div>
            <div class="form-group">
                <label for="my-bullets">è¦ç‚¹ï¼ˆæ”¯æŒã€æ ‡é¢˜ã€‘+æ­£æ–‡ï¼‰</label>
                <textarea id="my-bullets" placeholder="ä¾‹å¦‚ï¼šã€é˜²æ°´è®¾è®¡ã€‘é€‚åˆæˆ·å¤–ä½¿ç”¨\nã€è½»ä¾¿æ˜“æºã€‘é‡é‡ä»…200g"></textarea>
            </div>
            <div class="form-group">
                <label for="my-desc">äº§å“æè¿°ï¼ˆæ”¯æŒæ¢è¡Œï¼‰</label>
                <textarea id="my-desc" placeholder="è¾“å…¥è¯¦ç»†æè¿°ï¼Œæ”¯æŒæ®µè½æ ¼å¼"></textarea>
            </div>
            <div class="form-group">
                <label for="my-keywords">æœç´¢å…³é”®å­—</label>
                <input type="text" id="my-keywords" placeholder="ç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”" />
            </div>
            <div class="button-group">
                <button id="fill-content" class="tertiary-btn" disabled>ä¸€é”®å¡«å†™äº§å“ä¿¡æ¯</button>
            </div>
            <hr>

            <h4>ğŸ·ï¸ å‹å·ä¸è®¤è¯ä¿¡æ¯</h4>
            <div class="button-group">
                <button id="fill-model" class="tertiary-btn" disabled>ä¸€é”®ç”Ÿæˆå¹¶å¡«å†™å‹å·ä¿¡æ¯</button>
            </div>
            <hr>

            <h4>ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</h4>
            <div class="button-group">
                <button id="clear-all" class="danger-btn" disabled>ä¸€é”®æ¸…ç©ºæ‰€æœ‰å†…å®¹</button>
            </div>

            <div id="sc-statusMessage" class="status-message"></div>
        `;
        document.body.appendChild(panel);

        const baseSKUDisplay = document.getElementById('sc-baseSKU-display');
        const fillSKUBtn = document.getElementById('sc-fillSKU');
        const clearSKUBtn = document.getElementById('sc-clearSKU');
        const generateRandomBtn = document.getElementById('sc-generateRandomSKU');
        const copyBaseSKUBtn = document.getElementById('sc-copyBaseSKU');
        const fillContentBtn = document.getElementById('fill-content');
        const fillModelBtn = document.getElementById('fill-model');
        const clearAllBtn = document.getElementById('clear-all');

        const myTitle = document.getElementById('my-title');
        const myBullets = document.getElementById('my-bullets');
        const myDesc = document.getElementById('my-desc');
        const myKeywords = document.getElementById('my-keywords');

        let storedBaseSKU = await GM_getValue('sc-baseSKU', '');
        if (!storedBaseSKU) {
            storedBaseSKU = generateRandomBaseSKU();
            await GM_setValue('sc-baseSKU', storedBaseSKU);
        }
        baseSKUDisplay.textContent = storedBaseSKU;

        let autoCheckedDone = false;

        function clickKatCheckbox(kat) {
            if (!kat) return false;
            let inner = kat.shadowRoot?.querySelector('input[type="checkbox"], div[role="checkbox"], button');
            if (!inner) inner = kat;

            const isChecked = inner.getAttribute('aria-checked') === 'true' || inner.checked === true;
            if (!isChecked) {
                inner.click();
                return true;
            }
            return false;
        }

        function tryAutoCheck() {
            if (autoCheckedDone) return;

            const brandCheckbox = document.querySelector('#attribute-group-brand kat-checkbox.brand-checkbox, #attribute-group-brand div.brand-checkbox > kat-checkbox');
            const upcCheckbox = document.querySelector('#attribute-group-externally_assigned_product_identifier kat-checkbox.product-id-checkbox');

            let clicked = false;

            if (brandCheckbox && clickKatCheckbox(brandCheckbox)) {
                console.log('âœ… å·²å‹¾é€‰æ— å“ç‰Œ');
                clicked = true;
            }

            if (upcCheckbox && clickKatCheckbox(upcCheckbox)) {
                console.log('âœ… å·²å‹¾é€‰æ— å•†å“ç¼–ç ');
                clicked = true;
            }

            const brandChecked = brandCheckbox && (
                brandCheckbox.shadowRoot?.querySelector('input, div[role="checkbox"]')?.getAttribute('aria-checked') === 'true'
                || brandCheckbox.shadowRoot?.querySelector('input')?.checked === true
            );

            const upcChecked = upcCheckbox && (
                upcCheckbox.shadowRoot?.querySelector('input, div[role="checkbox"]')?.getAttribute('aria-checked') === 'true'
                || upcCheckbox.shadowRoot?.querySelector('input')?.checked === true
            );

            if (brandChecked && upcChecked) {
                autoCheckedDone = true;
                showStatus('âœ… å·²è‡ªåŠ¨å‹¾é€‰â€œæ— å“ç‰Œâ€å’Œâ€œæ— å•†å“ç¼–ç â€', true);
                console.log('âœ… æ£€æµ‹åˆ°ä¸¤ä¸ªå‹¾é€‰æ¡†å·²å®Œæˆï¼Œåœæ­¢ç›‘å¬');
                observer.disconnect();
            } else if (clicked) {
                showStatus('âœ… å·²å°è¯•å‹¾é€‰åˆè§„é€‰é¡¹', true);
            }
        }

        const observer = new MutationObserver(() => {
            tryAutoCheck();
        });

        observer.observe(document.body, { childList: true, subtree: true });

        setTimeout(tryAutoCheck, 3000);

        async function enableButtons() {
            setButtonState(fillSKUBtn, true, 'ä¸€é”®ç”Ÿæˆå­SKU');
            setButtonState(clearSKUBtn, true, 'æ¸…ç©ºè‡ªåŠ¨ç”ŸæˆSKU');
            setButtonState(fillContentBtn, true, 'ä¸€é”®å¡«å†™äº§å“ä¿¡æ¯');
            setButtonState(fillModelBtn, true, 'ä¸€é”®ç”Ÿæˆå¹¶å¡«å†™å‹å·ä¿¡æ¯');
            setButtonState(clearAllBtn, true, 'ä¸€é”®æ¸…ç©ºæ‰€æœ‰å†…å®¹');
        }

        try {
            await Promise.all([
                waitForElement('kat-textarea[name="item_name-0-value"]'),
                waitForElement('kat-input[name="model_number-0-value"]'),
                waitForElement('input[aria-label="SKU"]')
            ]);
            enableButtons();
            // === è‡ªåŠ¨æ‰§è¡Œï¼šå…ˆæ¸…ç©ºï¼Œå†å¡«å†™ ===
            await new Promise(resolve => setTimeout(resolve, 500)); // å»¶è¿Ÿä»¥ç¡®ä¿æŒ‰é’®å¯ç”¨
            clearAllBtn.click();
            await new Promise(resolve => setTimeout(resolve, 500));
            fillModelBtn.click();
            // ============================
        } catch (err) {
            console.warn('DOMåŠ è½½è¶…æ—¶ï¼Œä½†ä»å°è¯•å¯ç”¨æŒ‰é’®', err);
            enableButtons();
        }

        generateRandomBtn.addEventListener('click', async () => {
            const newSku = generateRandomBaseSKU();
            baseSKUDisplay.textContent = newSku;
            await GM_setValue('sc-baseSKU', newSku);
            showStatus("å·²ç”Ÿæˆæ–°çš„çˆ¶SKU", true);
        });

        copyBaseSKUBtn.addEventListener('click', async () => {
            const sku = baseSKUDisplay.textContent;
            if (!sku) {
                showStatus("æ²¡æœ‰å¯å¤åˆ¶çš„çˆ¶SKU", false);
                return;
            }
            try {
                await navigator.clipboard.writeText(sku);
                showStatus("çˆ¶SKUå·²å¤åˆ¶åˆ°å‰ªè´´æ¿", true);
            } catch (err) {
                showStatus("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶", false);
                console.error("å¤åˆ¶å¤±è´¥:", err);
            }
        });

        fillSKUBtn.addEventListener('click', async () => {
            const base = baseSKUDisplay.textContent;
            if (!base) {
                showStatus("è¯·å…ˆç”Ÿæˆæˆ–è®¾ç½®çˆ¶SKU", false);
                return;
            }

            setButtonState(fillSKUBtn, false, "ç”Ÿæˆä¸­...");
            const skuInputs = getAllSKUInputs();

            if (skuInputs.length === 0) {
                showStatus("æœªæ‰¾åˆ°SKUè¾“å…¥æ¡†", false);
                setButtonState(fillSKUBtn, true, "ä¸€é”®ç”Ÿæˆå­SKU");
                return;
            }

            let successCount = 0;
            skuInputs.forEach((input, i) => {
                try {
                    const sku = `${base}-${generateLetterSequence(i)}`;
                    setInputValue(input, sku);
                    successCount++;
                } catch (error) {
                    console.error("ç”ŸæˆSKUæ—¶å‡ºé”™:", error);
                }
            });

            setButtonState(fillSKUBtn, true, "ä¸€é”®ç”Ÿæˆå­SKU");
            showStatus(`æˆåŠŸç”Ÿæˆ ${successCount}/${skuInputs.length} ä¸ªSKU`, true);
        });

        clearSKUBtn.addEventListener('click', () => {
            setButtonState(clearSKUBtn, false, "æ¸…ç©ºä¸­...");
            const skuInputs = getAllSKUInputs();
            let clearedCount = 0;
            skuInputs.forEach(input => {
                if (input.getAttribute('data-auto-generated') === 'true') {
                    setInputValue(input, "");
                    clearedCount++;
                }
            });
            setButtonState(clearSKUBtn, true, "æ¸…ç©º");
            showStatus(`å·²æ¸…ç©º ${clearedCount} ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„SKU`, true);
        });

        fillContentBtn.addEventListener('click', () => {
            const title = myTitle.value.trim();
            const bulletRaw = myBullets.value.trim();
            const desc = myDesc.value.trim();
            const keywords = myKeywords.value.trim();

            let filledCount = 0;

            if (setKatTextareaValue('kat-textarea[name="item_name-0-value"]', title)) filledCount++;
            const bullets = parseBulletText(bulletRaw);
            for (let i = 0; i < 5; i++) {
                if (setKatTextareaValue(`kat-textarea[name="bullet_point-${i}-value"]`, bullets[i] || '')) filledCount++;
            }
            if (setKatTextareaValue('kat-textarea[name="product_description-0-value"]', convertToAmazonHTML(desc))) filledCount++;
            if (setKatInputValue('kat-input[name="generic_keyword-0-value"]', keywords)) filledCount++;

            if (filledCount > 0) {
                showStatus(`æˆåŠŸå¡«å†™ ${filledCount} é¡¹å†…å®¹`, true);
            } else {
                showStatus("âš ï¸ æœªæ‰¾åˆ°å¯¹åº”è¾“å…¥æ¡†ï¼Œè¯·ç¡®è®¤é¡µé¢å·²åŠ è½½", false);
            }
        });

        fillModelBtn.addEventListener('click', () => {
            const sku = generateRandomBaseSKU();
            let filledCount = 0;

            if (setKatInputValue('kat-input[name="model_number-0-value"]', sku)) filledCount++;
            if (setKatTextareaValue('kat-textarea[name="model_name-0-value"]', sku)) filledCount++;
            if (setKatInputValue('kat-input[name="manufacturer-0-value"]', sku)) filledCount++;
            if (setKatInputValue('kat-input[name="part_number-0-value"]', sku)) filledCount++;

            if (filledCount > 0) {
                showStatus(`å·²å¡«å†™å‹å·ä¿¡æ¯: ${sku}`, true);
            } else {
                showStatus("âš ï¸ æœªæ‰¾åˆ°å‹å·ç›¸å…³å­—æ®µ", false);
            }
        });

        clearAllBtn.addEventListener('click', () => {
            let clearedCount = 0;

            if (setKatTextareaValue('kat-textarea[name="item_name-0-value"]', '')) clearedCount++;
            for (let i = 0; i < 5; i++) {
                if (setKatTextareaValue(`kat-textarea[name="bullet_point-${i}-value"]`, '')) clearedCount++;
            }
            if (setKatTextareaValue('kat-textarea[name="product_description-0-value"]', '')) clearedCount++;
            if (setKatInputValue('kat-input[name="generic_keyword-0-value"]', '')) clearedCount++;
            if (setKatInputValue('kat-input[name="model_number-0-value"]', '')) clearedCount++;
            if (setKatTextareaValue('kat-textarea[name="model_name-0-value"]', '')) clearedCount++;
            if (setKatInputValue('kat-input[name="manufacturer-0-value"]', '')) clearedCount++;
            if (setKatInputValue('kat-input[name="part_number-0-value"]', '')) clearedCount++;

            showStatus(`å·²æ¸…ç©º ${clearedCount} é¡¹å†…å®¹`, true);
        });

        const cachedTitle = await GM_getValue('cached-title', '');
        const cachedBullets = await GM_getValue('cached-bullets', '');
        const cachedDesc = await GM_getValue('cached-desc', '');
        const cachedKeywords = await GM_getValue('cached-keywords', '');

        myTitle.value = cachedTitle;
        myBullets.value = cachedBullets;
        myDesc.value = cachedDesc;
        myKeywords.value = cachedKeywords;

        myTitle.addEventListener('input', () => GM_setValue('cached-title', myTitle.value));
        myBullets.addEventListener('input', () => GM_setValue('cached-bullets', myBullets.value));
        myDesc.addEventListener('input', () => GM_setValue('cached-desc', myDesc.value));
        myKeywords.addEventListener('input', () => GM_setValue('cached-keywords', myKeywords.value));

        showStatus("âœ… å·¥å…·å·²åŠ è½½ï¼Œæ­£åœ¨è‡ªåŠ¨å‹¾é€‰åˆè§„é€‰é¡¹...", true);
    }
    // =============== å¯åŠ¨å…¥å£ ===============
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPanel);
    } else {
        initPanel();
    }

})();
