// ==UserScript==
// @name         Amazon Listing ä¸€é”®å¡«å†™æè¿°ä¸è¦ç‚¹ï¼ˆæ”¯æŒæ ‡é¢˜æ ¼å¼ï¼‰
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  ä¸€é”®å¡«å†™äº§å“æè¿°ä¸è¦ç‚¹ï¼Œæ”¯æŒã€æ ‡é¢˜ã€‘+æ­£æ–‡æ ¼å¼
// @author       You
// @match        https://sellercentral.amazon.com/abis/listing/*
// @match        https://sellercentral.amazon.ca/abis/listing/*
// @match        https://sellercentral.amazon.com.mx/abis/listing/*
// @match        https://sellercentral-japan.amazon.com/abis/listing/*
// @match        https://sellercentral.amazon.com.au/abis/listing/*
// @match        https://sellercentral.amazon.co.uk/abis/listing/*
// @match        https://sellercentral.amazon.de/abis/listing/*
// @match        https://sellercentral.amazon.fr/abis/listing/*
// @match        https://sellercentral.amazon.it/abis/listing/*
// @match        https://sellercentral.amazon.es/abis/listing/*
// @match        https://sellercentral.amazon.nl/abis/listing/*
// @match        https://sellercentral.amazon.se/abis/listing/*
// @match        https://sellercentral.amazon.pl/abis/listing/*
// @match        https://sellercentral.amazon.be/abis/listing/*
// @icon         https://www.amazon.com/favicon.ico
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    // åˆ›å»ºé¢æ¿
    function createPanel() {
        if (document.getElementById('auto-fill-panel')) return;
        const panel = document.createElement('div');
        panel.id = 'auto-fill-panel';
        panel.style.position = 'fixed';
        panel.style.top = '100px';
        panel.style.right = '20px';
        panel.style.zIndex = '99999';
        panel.style.background = '#fff';
        panel.style.border = '2px solid #ccc';
        panel.style.padding = '15px';
        panel.style.width = '300px';
        panel.style.fontSize = '14px';
        panel.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';

        panel.innerHTML = `
          <h3 style="margin-top:0;font-size:16px;">ğŸ“ ä¸€é”®å¡«å†™å·¥å…·</h3>
          <label>äº§å“æè¿°ï¼š</label>
          <textarea id="my-desc" rows="6" style="width:100%;margin-bottom:10px;"></textarea>
          <label>è¦ç‚¹ï¼ˆæ”¯æŒã€æ ‡é¢˜ã€‘+æ­£æ–‡æ ¼å¼ï¼‰ï¼š</label>
          <textarea id="my-bullets" rows="10" style="width:100%;margin-bottom:10px;"></textarea>
          <button id="fill-btn" style="width:100%;padding:8px;background:#ff9900;color:#fff;border:none;cursor:pointer;">ä¸€é”®å¡«å†™</button>
        `;
        document.body.appendChild(panel);
        document.getElementById('fill-btn').addEventListener('click', autoFill);
    }

    // å°†æè¿°è½¬ä¸ºHTMLå…è®¸æ ‡ç­¾ï¼ˆä¿ç•™æ®µè½å’Œæ¢è¡Œï¼‰
    function convertToAmazonHTML(text) {
        const paragraphs = text.trim().split(/\n{2,}/).map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`);
        return paragraphs.join('');
    }

    // å¾€ kat-textarea è¾“å…¥å†…å®¹
    function setKatTextareaValue(selector, value) {
        const kat = document.querySelector(selector);
        if (!kat) return false;
        const real = kat.shadowRoot && kat.shadowRoot.querySelector('textarea');
        if (!real) return false;
        real.value = value;
        real.dispatchEvent(new Event('input', { bubbles: true, composed: true }));
        return true;
    }

    // è§£æè¦ç‚¹ï¼šæ”¯æŒã€æ ‡é¢˜ã€‘æ­£æ–‡æ ¼å¼
    function parseBulletText(text) {
        const matches = [...text.matchAll(/ã€(.*?)ã€‘([\s\S]*?)(?=(?:ã€|$))/g)];
        return matches.slice(0, 5).map(m => `ã€${m[1].trim()}ã€‘${m[2].trim().replace(/\n+/g, ' ')}`);
    }

    // ä¸€é”®å¡«å†™é€»è¾‘
    function autoFill() {
        const desc = document.getElementById('my-desc').value;
        const bulletRaw = document.getElementById('my-bullets').value;

        const htmlDesc = convertToAmazonHTML(desc);
        const descOk = setKatTextareaValue('kat-textarea[name="product_description-0-value"]', htmlDesc);

        const bullets = parseBulletText(bulletRaw);
        let bulletOk = false;
        for (let i = 0; i < 5; i++) {
            const bullet = bullets[i] || '';
            const ok = setKatTextareaValue(`kat-textarea[name="bullet_point-${i}-value"]`, bullet);
            if (ok) bulletOk = true;
        }

        if (descOk || bulletOk) {
            alert('å·²å®Œæˆå¡«å†™ âœ…');
        } else {
            alert('âš ï¸ æ²¡æ‰¾åˆ°è¾“å…¥æ¡†ï¼Œè¯·ç¡®è®¤å½“å‰é¡µé¢å·²åŠ è½½å®Œæˆ');
        }
    }

    function waitForPage() {
        if (document.querySelector('kat-textarea[name="product_description-0-value"]')) {
            createPanel();
        } else {
            setTimeout(waitForPage, 2000);
        }
    }

    waitForPage();
})();
