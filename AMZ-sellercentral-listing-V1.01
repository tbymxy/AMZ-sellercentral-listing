// ==UserScript==
// @name        Amazon Listing ä¸€é”®å¡«å†™æè¿°ä¸è¦ç‚¹ï¼ˆæ”¯æŒæ ‡é¢˜æ ¼å¼ï¼‰
// @namespace   http://tampermonkey.net/
// @version     1.6
// @description ä¸€é”®å¡«å†™äº§å“æè¿°ä¸è¦ç‚¹ï¼Œæ”¯æŒã€æ ‡é¢˜ã€‘+æ­£æ–‡æ ¼å¼ã€‚æ–°å¢æ ‡é¢˜ã€æœç´¢å…³é”®å­—ä»¥åŠå‹å·ã€å‹å·åç§°ã€åˆ¶é€ å•†ã€é›¶ä»¶ç¼–å·çš„å¡«å†™ï¼Œå¹¶æ·»åŠ ä¸€é”®æ¸…ç©ºåŠŸèƒ½ï¼ˆåŒæ—¶å‹¾é€‰æ— å“ç‰Œå’Œæ— å•†å“ç¼–ç ï¼‰ã€‚
// @author      You
// @match       https://sellercentral.amazon.com/abis/listing/*
// @match       https://sellercentral.amazon.ca/abis/listing/*
// @match       https://sellercentral.amazon.com.mx/abis/listing/*
// @match       https://sellercentral-japan.amazon.com/abis/listing/*
// @match       https://sellercentral.amazon.com.au/abis/listing/*
// @match       https://sellercentral.amazon.co.uk/abis/listing/*
// @match       https://sellercentral.amazon.de/abis/listing/*
// @match       https://sellercentral.amazon.fr/abis/listing/*
// @match       https://sellercentral.amazon.it/abis/listing/*
// @match       https://sellercentral.amazon.es/abis/listing/*
// @match       https://sellercentral.amazon.nl/abis/listing/*
// @match       https://sellercentral.amazon.se/abis/listing/*
// @match       https://sellercentral.amazon.pl/abis/listing/*
// @match       https://sellercentral.amazon.be/abis/listing/*
// @icon        https://www.amazon.com/favicon.ico
// @grant       none
// ==/UserScript==

(function () {
    'use strict';

    // éšæœº SKU ç”Ÿæˆå™¨
    const usedSKUs = new Set();
    function generateSKU() {
        const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
        const prefix = "A" + date;
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let random = "";
        for (let i = 0; i < 2; i++) {
            random += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        const sku = `${prefix}-${random}`;
        if (usedSKUs.has(sku)) return generateSKU();
        usedSKUs.add(sku);
        return sku;
    }

    // åˆ›å»ºé¢æ¿
    function createPanel() {
        if (document.getElementById('auto-fill-panel')) return;
        const panel = document.createElement('div');
        panel.id = 'auto-fill-panel';
        panel.style.position = 'fixed';
        panel.style.top = '100px';
        panel.style.right = '20px';
        panel.style.zIndex = '99999';
        panel.style.background = '#fff';
        panel.style.border = '2px solid #ccc';
        panel.style.padding = '15px';
        panel.style.width = '350px';
        panel.style.fontSize = '14px';
        panel.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';

        panel.innerHTML = `
          <h3 style="margin-top:0;font-size:16px;">ğŸ“ ä¸€é”®å¡«å†™å·¥å…·</h3>
          <label>æ ‡é¢˜ï¼š</label>
          <input type="text" id="my-title" style="width:100%;padding:5px;margin-bottom:10px;"/>
          <label>è¦ç‚¹ï¼ˆæ”¯æŒã€æ ‡é¢˜ã€‘+æ­£æ–‡æ ¼å¼ï¼‰ï¼š</label>
          <textarea id="my-bullets" rows="10" style="width:100%;margin-bottom:10px;"></textarea>
          <label>äº§å“æè¿°ï¼š</label>
          <textarea id="my-desc" rows="6" style="width:100%;margin-bottom:10px;"></textarea>
          <label>æœç´¢å…³é”®å­—ï¼š</label>
          <input type="text" id="my-keywords" style="width:100%;padding:5px;margin-bottom:10px;"/>
          <button id="fill-btn" style="width:100%;padding:8px;background:#ff9900;color:#fff;border:none;cursor:pointer;margin-top:10px;">ä¸€é”®å¡«å†™äº§å“ä¿¡æ¯</button>
          <button id="fill-sku-btn" style="width:100%;padding:8px;background:#28a745;color:#fff;border:none;cursor:pointer;margin-top:10px;">ä¸€é”®ç”Ÿæˆå¹¶å¡«å†™ SKU/å‹å·ä¿¡æ¯</button>
          <button id="clear-btn" style="width:100%;padding:8px;background:#dc3545;color:#fff;border:none;cursor:pointer;margin-top:10px;">ä¸€é”®æ¸…ç©ºæ‰€æœ‰å†…å®¹</button>
        `;
        document.body.appendChild(panel);
        document.getElementById('fill-btn').addEventListener('click', autoFill);
        document.getElementById('fill-sku-btn').addEventListener('click', autoFillSKU);
        document.getElementById('clear-btn').addEventListener('click', clearAll);
    }

    // å°†æè¿°è½¬ä¸ºHTMLå…è®¸æ ‡ç­¾ï¼ˆä¿ç•™æ®µè½å’Œæ¢è¡Œï¼‰
    function convertToAmazonHTML(text) {
        if (!text) return '';
        const paragraphs = text.trim().split(/\n{2,}/).map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`);
        return paragraphs.join('');
    }

    // å¾€ kat-textarea è¾“å…¥å†…å®¹
    function setKatTextareaValue(selector, value) {
        const kat = document.querySelector(selector);
        if (!kat) return false;
        const real = kat.shadowRoot && kat.shadowRoot.querySelector('textarea');
        if (!real) return false;
        real.value = value;
        real.dispatchEvent(new Event('input', { bubbles: true, composed: true }));
        return true;
    }

    // å¾€ kat-input è¾“å…¥å†…å®¹
    function setKatInputValue(selector, value) {
        const kat = document.querySelector(selector);
        if (!kat) return false;
        const real = kat.shadowRoot && kat.shadowRoot.querySelector('input');
        if (!real) return false;
        real.value = value;
        real.dispatchEvent(new Event('input', { bubbles: true, composed: true }));
        return true;
    }

    // å‹¾é€‰/å–æ¶ˆå‹¾é€‰ kat-checkbox
    function setKatCheckboxChecked(selector, checked) {
        const kat = document.querySelector(selector);
        if (!kat) return false;
        const real = kat.shadowRoot && kat.shadowRoot.querySelector('input[type="checkbox"]');
        if (!real) return false;
        if (real.checked !== checked) {
            real.click(); // æ¨¡æ‹Ÿç‚¹å‡»æ¥è§¦å‘äºšé©¬é€Šå†…éƒ¨é€»è¾‘
        }
        return true;
    }

    // è§£æè¦ç‚¹ï¼šæ”¯æŒã€æ ‡é¢˜ã€‘æ­£æ–‡æ ¼å¼
    function parseBulletText(text) {
        const matches = [...text.matchAll(/ã€(.*?)ã€‘([\s\S]*?)(?=(?:ã€|$))/g)];
        return matches.slice(0, 5).map(m => `ã€${m[1].trim()}ã€‘${m[2].trim().replace(/\n+/g, ' ')}`);
    }

    // ä¸€é”®å¡«å†™äº§å“ä¿¡æ¯é€»è¾‘
    function autoFill() {
        const title = document.getElementById('my-title').value;
        const bulletRaw = document.getElementById('my-bullets').value;
        const desc = document.getElementById('my-desc').value;
        const keywords = document.getElementById('my-keywords').value;

        let filledCount = 0;

        // å¡«å†™æ ‡é¢˜
        if (setKatTextareaValue('kat-textarea[name="item_name-0-value"]', title)) {
            filledCount++;
        }

        // å¡«å†™è¦ç‚¹
        const bullets = parseBulletText(bulletRaw);
        for (let i = 0; i < 5; i++) {
            const bullet = bullets[i] || '';
            if (setKatTextareaValue(`kat-textarea[name="bullet_point-${i}-value"]`, bullet)) {
                filledCount++;
            }
        }

        // å¡«å†™äº§å“æè¿°
        const htmlDesc = convertToAmazonHTML(desc);
        if (setKatTextareaValue('kat-textarea[name="product_description-0-value"]', htmlDesc)) {
            filledCount++;
        }

        // å¡«å†™æœç´¢å…³é”®å­—
        if (setKatInputValue('kat-input[name="generic_keyword-0-value"]', keywords)) {
            filledCount++;
        }

        if (filledCount > 0) {
            alert('å·²å®Œæˆå¡«å†™äº§å“ä¿¡æ¯ âœ…');
        } else {
            alert('âš ï¸ æ²¡æ‰¾åˆ°è¾“å…¥æ¡†ï¼Œè¯·ç¡®è®¤å½“å‰é¡µé¢å·²åŠ è½½å®Œæˆ');
        }
    }

    // ä¸€é”®å¡«å†™ SKU/å‹å·ä¿¡æ¯é€»è¾‘
    function autoFillSKU() {
        const sku = generateSKU();
        let filledCount = 0;

        // å¡«å†™ å‹å· (kat-input)
        if (setKatInputValue('kat-input[name="model_number-0-value"]', sku)) {
            filledCount++;
        }

        // å¡«å†™ å‹å·åç§° (kat-textarea)
        if (setKatTextareaValue('kat-textarea[name="model_name-0-value"]', sku)) {
            filledCount++;
        }

        // å¡«å†™ åˆ¶é€ å•† (kat-input)
        if (setKatInputValue('kat-input[name="manufacturer-0-value"]', sku)) {
            filledCount++;
        }

        // å¡«å†™ é›¶ä»¶ç¼–å· (kat-input)
        if (setKatInputValue('kat-input[name="part_number-0-value"]', sku)) {
            filledCount++;
        }

        if (filledCount > 0) {
            alert(`å·²ç”Ÿæˆå¹¶å¡«å†™ SKU/å‹å·ä¿¡æ¯: ${sku} âœ…`);
        } else {
            alert('âš ï¸ æ²¡æ‰¾åˆ°å‹å·/åˆ¶é€ å•†ç­‰è¾“å…¥æ¡†ï¼Œè¯·ç¡®è®¤å½“å‰é¡µé¢å·²åŠ è½½å®Œæˆ');
        }
    }

    // ä¸€é”®æ¸…ç©ºæ‰€æœ‰å†…å®¹é€»è¾‘
    function clearAll() {
        let clearedCount = 0;

        // æ¸…ç©ºæ ‡é¢˜
        if (setKatTextareaValue('kat-textarea[name="item_name-0-value"]', '')) {
            clearedCount++;
        }

        // æ¸…ç©ºè¦ç‚¹
        for (let i = 0; i < 5; i++) {
            if (setKatTextareaValue(`kat-textarea[name="bullet_point-${i}-value"]`, '')) {
                clearedCount++;
            }
        }

        // æ¸…ç©ºäº§å“æè¿°
        if (setKatTextareaValue('kat-textarea[name="product_description-0-value"]', '')) {
            clearedCount++;
        }

        // æ¸…ç©ºæœç´¢å…³é”®å­—
        if (setKatInputValue('kat-input[name="generic_keyword-0-value"]', '')) {
            clearedCount++;
        }

        // æ¸…ç©º SKU/å‹å·ä¿¡æ¯
        if (setKatInputValue('kat-input[name="model_number-0-value"]', '')) {
            clearedCount++;
        }
        if (setKatTextareaValue('kat-textarea[name="model_name-0-value"]', '')) {
            clearedCount++;
        }
        if (setKatInputValue('kat-input[name="manufacturer-0-value"]', '')) {
            clearedCount++;
        }
        if (setKatInputValue('kat-input[name="part_number-0-value"]', '')) {
            clearedCount++;
        }

        // å‹¾é€‰ â€œæ­¤å•†å“æ²¡æœ‰å“ç‰Œåç§°â€
        if (setKatCheckboxChecked('kat-checkbox[data-testid="no-brand-name-checkbox"]', true)) {
            clearedCount++;
        }

        // å‹¾é€‰ â€œæˆ‘æ²¡æœ‰å•†å“ç¼–ç â€
        if (setKatCheckboxChecked('kat-checkbox[data-cy="upc-exemption-checkbox"]', true)) {
            clearedCount++;
        }


        if (clearedCount > 0) {
            alert('å·²æ¸…ç©ºæ‰€æœ‰å†…å®¹å¹¶å‹¾é€‰æ— å“ç‰Œ/æ— å•†å“ç¼–ç é€‰é¡¹ âœ…');
        } else {
            alert('âš ï¸ æ²¡æ‰¾åˆ°ä»»ä½•è¾“å…¥æ¡†ï¼Œè¯·ç¡®è®¤å½“å‰é¡µé¢å·²åŠ è½½å®Œæˆ');
        }
    }

    function waitForPage() {
        // ç­‰å¾…ä»»æ„ä¸€ä¸ªå…³é”®å…ƒç´ åŠ è½½ï¼Œä»¥åˆ¤æ–­é¡µé¢å°±ç»ª
        if (document.querySelector('kat-textarea[name="product_description-0-value"]') ||
            document.querySelector('kat-textarea[name="item_name-0-value"]') ||
            document.querySelector('kat-input[name="model_number-0-value"]')) {
            createPanel();
        } else {
            setTimeout(waitForPage, 2000);
        }
    }

    waitForPage();
})();
