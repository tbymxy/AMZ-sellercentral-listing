// ==UserScript==
// @name        Amazon Listing 一键填写描述与要点（支持标题格式）
// @namespace   http://tampermonkey.net/
// @version     1.6
// @description 一键填写产品描述与要点，支持【标题】+正文格式。新增标题、搜索关键字以及型号、型号名称、制造商、零件编号的填写，并添加一键清空功能（同时勾选无品牌和无商品编码）。
// @author      You
// @match       https://sellercentral.amazon.com/abis/listing/*
// @match       https://sellercentral.amazon.ca/abis/listing/*
// @match       https://sellercentral.amazon.com.mx/abis/listing/*
// @match       https://sellercentral-japan.amazon.com/abis/listing/*
// @match       https://sellercentral.amazon.com.au/abis/listing/*
// @match       https://sellercentral.amazon.co.uk/abis/listing/*
// @match       https://sellercentral.amazon.de/abis/listing/*
// @match       https://sellercentral.amazon.fr/abis/listing/*
// @match       https://sellercentral.amazon.it/abis/listing/*
// @match       https://sellercentral.amazon.es/abis/listing/*
// @match       https://sellercentral.amazon.nl/abis/listing/*
// @match       https://sellercentral.amazon.se/abis/listing/*
// @match       https://sellercentral.amazon.pl/abis/listing/*
// @match       https://sellercentral.amazon.be/abis/listing/*
// @icon        https://www.amazon.com/favicon.ico
// @grant       none
// ==/UserScript==

(function () {
    'use strict';

    // 随机 SKU 生成器
    const usedSKUs = new Set();
    function generateSKU() {
        const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
        const prefix = "A" + date;
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let random = "";
        for (let i = 0; i < 2; i++) {
            random += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        const sku = `${prefix}-${random}`;
        if (usedSKUs.has(sku)) return generateSKU();
        usedSKUs.add(sku);
        return sku;
    }

    // 创建面板
    function createPanel() {
        if (document.getElementById('auto-fill-panel')) return;
        const panel = document.createElement('div');
        panel.id = 'auto-fill-panel';
        panel.style.position = 'fixed';
        panel.style.top = '100px';
        panel.style.right = '20px';
        panel.style.zIndex = '99999';
        panel.style.background = '#fff';
        panel.style.border = '2px solid #ccc';
        panel.style.padding = '15px';
        panel.style.width = '350px';
        panel.style.fontSize = '14px';
        panel.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';

        panel.innerHTML = `
          <h3 style="margin-top:0;font-size:16px;">📝 一键填写工具</h3>
          <label>标题：</label>
          <input type="text" id="my-title" style="width:100%;padding:5px;margin-bottom:10px;"/>
          <label>要点（支持【标题】+正文格式）：</label>
          <textarea id="my-bullets" rows="10" style="width:100%;margin-bottom:10px;"></textarea>
          <label>产品描述：</label>
          <textarea id="my-desc" rows="6" style="width:100%;margin-bottom:10px;"></textarea>
          <label>搜索关键字：</label>
          <input type="text" id="my-keywords" style="width:100%;padding:5px;margin-bottom:10px;"/>
          <button id="fill-btn" style="width:100%;padding:8px;background:#ff9900;color:#fff;border:none;cursor:pointer;margin-top:10px;">一键填写产品信息</button>
          <button id="fill-sku-btn" style="width:100%;padding:8px;background:#28a745;color:#fff;border:none;cursor:pointer;margin-top:10px;">一键生成并填写 SKU/型号信息</button>
          <button id="clear-btn" style="width:100%;padding:8px;background:#dc3545;color:#fff;border:none;cursor:pointer;margin-top:10px;">一键清空所有内容</button>
        `;
        document.body.appendChild(panel);
        document.getElementById('fill-btn').addEventListener('click', autoFill);
        document.getElementById('fill-sku-btn').addEventListener('click', autoFillSKU);
        document.getElementById('clear-btn').addEventListener('click', clearAll);
    }

    // 将描述转为HTML允许标签（保留段落和换行）
    function convertToAmazonHTML(text) {
        if (!text) return '';
        const paragraphs = text.trim().split(/\n{2,}/).map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`);
        return paragraphs.join('');
    }

    // 往 kat-textarea 输入内容
    function setKatTextareaValue(selector, value) {
        const kat = document.querySelector(selector);
        if (!kat) return false;
        const real = kat.shadowRoot && kat.shadowRoot.querySelector('textarea');
        if (!real) return false;
        real.value = value;
        real.dispatchEvent(new Event('input', { bubbles: true, composed: true }));
        return true;
    }

    // 往 kat-input 输入内容
    function setKatInputValue(selector, value) {
        const kat = document.querySelector(selector);
        if (!kat) return false;
        const real = kat.shadowRoot && kat.shadowRoot.querySelector('input');
        if (!real) return false;
        real.value = value;
        real.dispatchEvent(new Event('input', { bubbles: true, composed: true }));
        return true;
    }

    // 勾选/取消勾选 kat-checkbox
    function setKatCheckboxChecked(selector, checked) {
        const kat = document.querySelector(selector);
        if (!kat) return false;
        const real = kat.shadowRoot && kat.shadowRoot.querySelector('input[type="checkbox"]');
        if (!real) return false;
        if (real.checked !== checked) {
            real.click(); // 模拟点击来触发亚马逊内部逻辑
        }
        return true;
    }

    // 解析要点：支持【标题】正文格式
    function parseBulletText(text) {
        const matches = [...text.matchAll(/【(.*?)】([\s\S]*?)(?=(?:【|$))/g)];
        return matches.slice(0, 5).map(m => `【${m[1].trim()}】${m[2].trim().replace(/\n+/g, ' ')}`);
    }

    // 一键填写产品信息逻辑
    function autoFill() {
        const title = document.getElementById('my-title').value;
        const bulletRaw = document.getElementById('my-bullets').value;
        const desc = document.getElementById('my-desc').value;
        const keywords = document.getElementById('my-keywords').value;

        let filledCount = 0;

        // 填写标题
        if (setKatTextareaValue('kat-textarea[name="item_name-0-value"]', title)) {
            filledCount++;
        }

        // 填写要点
        const bullets = parseBulletText(bulletRaw);
        for (let i = 0; i < 5; i++) {
            const bullet = bullets[i] || '';
            if (setKatTextareaValue(`kat-textarea[name="bullet_point-${i}-value"]`, bullet)) {
                filledCount++;
            }
        }

        // 填写产品描述
        const htmlDesc = convertToAmazonHTML(desc);
        if (setKatTextareaValue('kat-textarea[name="product_description-0-value"]', htmlDesc)) {
            filledCount++;
        }

        // 填写搜索关键字
        if (setKatInputValue('kat-input[name="generic_keyword-0-value"]', keywords)) {
            filledCount++;
        }

        if (filledCount > 0) {
            alert('已完成填写产品信息 ✅');
        } else {
            alert('⚠️ 没找到输入框，请确认当前页面已加载完成');
        }
    }

    // 一键填写 SKU/型号信息逻辑
    function autoFillSKU() {
        const sku = generateSKU();
        let filledCount = 0;

        // 填写 型号 (kat-input)
        if (setKatInputValue('kat-input[name="model_number-0-value"]', sku)) {
            filledCount++;
        }

        // 填写 型号名称 (kat-textarea)
        if (setKatTextareaValue('kat-textarea[name="model_name-0-value"]', sku)) {
            filledCount++;
        }

        // 填写 制造商 (kat-input)
        if (setKatInputValue('kat-input[name="manufacturer-0-value"]', sku)) {
            filledCount++;
        }

        // 填写 零件编号 (kat-input)
        if (setKatInputValue('kat-input[name="part_number-0-value"]', sku)) {
            filledCount++;
        }

        if (filledCount > 0) {
            alert(`已生成并填写 SKU/型号信息: ${sku} ✅`);
        } else {
            alert('⚠️ 没找到型号/制造商等输入框，请确认当前页面已加载完成');
        }
    }

    // 一键清空所有内容逻辑
    function clearAll() {
        let clearedCount = 0;

        // 清空标题
        if (setKatTextareaValue('kat-textarea[name="item_name-0-value"]', '')) {
            clearedCount++;
        }

        // 清空要点
        for (let i = 0; i < 5; i++) {
            if (setKatTextareaValue(`kat-textarea[name="bullet_point-${i}-value"]`, '')) {
                clearedCount++;
            }
        }

        // 清空产品描述
        if (setKatTextareaValue('kat-textarea[name="product_description-0-value"]', '')) {
            clearedCount++;
        }

        // 清空搜索关键字
        if (setKatInputValue('kat-input[name="generic_keyword-0-value"]', '')) {
            clearedCount++;
        }

        // 清空 SKU/型号信息
        if (setKatInputValue('kat-input[name="model_number-0-value"]', '')) {
            clearedCount++;
        }
        if (setKatTextareaValue('kat-textarea[name="model_name-0-value"]', '')) {
            clearedCount++;
        }
        if (setKatInputValue('kat-input[name="manufacturer-0-value"]', '')) {
            clearedCount++;
        }
        if (setKatInputValue('kat-input[name="part_number-0-value"]', '')) {
            clearedCount++;
        }

        // 勾选 “此商品没有品牌名称”
        if (setKatCheckboxChecked('kat-checkbox[data-testid="no-brand-name-checkbox"]', true)) {
            clearedCount++;
        }

        // 勾选 “我没有商品编码”
        if (setKatCheckboxChecked('kat-checkbox[data-cy="upc-exemption-checkbox"]', true)) {
            clearedCount++;
        }


        if (clearedCount > 0) {
            alert('已清空所有内容并勾选无品牌/无商品编码选项 ✅');
        } else {
            alert('⚠️ 没找到任何输入框，请确认当前页面已加载完成');
        }
    }

    function waitForPage() {
        // 等待任意一个关键元素加载，以判断页面就绪
        if (document.querySelector('kat-textarea[name="product_description-0-value"]') ||
            document.querySelector('kat-textarea[name="item_name-0-value"]') ||
            document.querySelector('kat-input[name="model_number-0-value"]')) {
            createPanel();
        } else {
            setTimeout(waitForPage, 2000);
        }
    }

    waitForPage();
})();
